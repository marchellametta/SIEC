DROP PROCEDURE IF EXISTS  `sp_get_stok_kategori_spesifik`;

DELIMITER $$
CREATE PROCEDURE `sp_get_stok_kategori_spesifik`(
	in tgl_awal datetime,
    in tgl_akhir datetime
)
BEGIN
select 
	SIMA_KATEGORI_SPESIFIK_MT.ID_KATEGORI_SPESIFIK,
    SIMA_KATEGORI_SPESIFIK_MT.N_STOK - stok_dipinjam.jumlah_dipinjam as jumlah_tersisa
from SIMA_KATEGORI_SPESIFIK_MT
join (
	select
		sima_detil_peminjaman_kategori_spesifik_dt.ID_KATEGORI_SPESIFIK,
		sum(sima_detil_peminjaman_kategori_spesifik_dt.N_KUANTITAS_TERSEDIA) as jumlah_dipinjam
	from SIMA_PEMINJAMAN_TR 
	join sima_detil_peminjaman_kategori_spesifik_dt
	on sima_detil_peminjaman_kategori_spesifik_dt.ID_PEMINJAMAN = SIMA_PEMINJAMAN_TR.ID_PEMINJAMAN
    where (
			(
				tgl_akhir >= SIMA_PEMINJAMAN_TR.DT_WAKTU_MULAI_PINJAM AND
                tgl_awal <= SIMA_PEMINJAMAN_TR.DT_WAKTU_SELESAI_PINJAM
            )
            or (
				tgl_awal <= SIMA_PEMINJAMAN_TR.DT_WAKTU_MULAI_PINJAM
                and tgl_akhir >= SIMA_PEMINJAMAN_TR.DT_WAKTU_SELESAI_PINJAM
            )
            or (
				tgl_awal >= SIMA_PEMINJAMAN_TR.DT_WAKTU_MULAI_PINJAM
                and tgl_akhir <= SIMA_PEMINJAMAN_TR.DT_WAKTU_SELESAI_PINJAM
            )
        )
	group by sima_detil_peminjaman_kategori_spesifik_dt.ID_KATEGORI_SPESIFIK
) as stok_dipinjam
on stok_dipinjam.ID_KATEGORI_SPESIFIK = SIMA_KATEGORI_SPESIFIK_MT.ID_KATEGORI_SPESIFIK;
END $$
DELIMITER ;